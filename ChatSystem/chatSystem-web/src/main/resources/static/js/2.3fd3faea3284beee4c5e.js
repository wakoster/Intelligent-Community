webpackJsonp([2],{"2ddZ":function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var o=t("mvHQ"),n=t.n(o);var a={components:{errorMessage:t("AVWw").a},name:"Chat",data:function(){return{chattingRecord:{createTime:null,senderUserInfo:null,receiverUserInfo:null,chattingRecord:null},socket:"",selfUserInfo:{id:1},info:{userId:null,userName:null,userImg:null,chattingRecordPage:0},talkTag:{},sessionMsg:{},userInformation:{code:null,msg:null,total:null,data:{userImg:null,name:null,id:null,phoneNumber:null,mailbox:null,address:null,department:null}}}},mounted:function(){this.info.userId=this.$route.query.userId,this.getSelfUserInfo(),this.getChatList()},methods:{getSelfUserInfo:function(){var e=this;this.$axios.get("/user/getSelfUserInfo").then(function(s){var t=s.data;0===t.code?(e.selfUserInfo=t.data,e.webSocketInit()):e.showErrorMessage(t.msg)}).catch(function(s){e.showErrorMessage(s)})},clickTalkBox:function(e,s){this.sessionMsg={},this.info.userId=s.userId,this.info.userName=s.userName,this.info.userImg=s.userImg,this.info.chattingRecordPage=0,null!==document.querySelector(".more.hidden")&&document.querySelector(".more").classList.add("hidden"),document.querySelectorAll(".talkbox.active").forEach(function(e){return e.classList.remove("active")}),e.currentTarget.className+=" active",this.moreChattingRecord(!1)},moreChattingRecord:function(e){var s=this,t=null,o=null;e&&(t=document.querySelector(".session-window").scrollHeight,o=document.querySelector(".session-window").scrollTop),this.$axios.post("/chat/getChattingRecord",{id:this.selfUserInfo.id,chatUserId:this.info.userId,page:this.info.chattingRecordPage}).then(function(t){var o=t.data;0===o.code?("{}"===n()(s.sessionMsg)?s.sessionMsg=o:s.sessionMsg.data=o.data.concat(s.sessionMsg.data),s.info.chattingRecordPage+=1,o.data.length<20&&null!==document.querySelector(".more")?document.querySelector(".more").classList.add("hidden"):20===o.data.length&&null!==document.querySelector(".more.hidden")&&document.querySelector(".more.hidden").classList.remove("hidden"),e||s.$nextTick(function(){document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight})):s.showErrorMessage(o.msg)}).catch(function(e){s.showErrorMessage(e)}).finally(function(){e&&(document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight-t+o)})},chattingScrollToBottom:function(){var e=this;this.$nextTick(function(){var s=e.$el.querySelector(".session-window");s.scrollTop=s.scrollHeight})},getChatList:function(){var e=this;this.$axios.post("/chat/getChatList",{phoneNumber:this.$cookies.get("cookie_userPhoneNumber"),userId:this.info.userId}).then(function(s){var t=s.data;if(0===t.code){if(e.talkTag=t,null!==e.info.userId)for(var o=0;o<e.talkTag.data.length;o++)if(e.talkTag.data[o].userId.toString()===e.info.userId){e.sessionMsg={},e.info.userId=e.talkTag.data[o].userId,e.info.userName=e.talkTag.data[o].userName,e.info.userImg=e.talkTag.data[o].userImg,e.info.chattingRecordPage=0,e.talkTag.data[o].unreadMessage=0,e.moreChattingRecord(!1);break}}else e.showErrorMessage(t.msg)}).catch(function(s){e.showErrorMessage(s)})},getUserInfo:function(){var e=this;this.$axios.post("/user/getUserInfo",{id:this.info.userId}).then(function(s){var t=s.data;0===t.code?e.userInformation=t:e.showErrorMessage(t.msg)}).catch(function(s){e.showErrorMessage(s)})},formatDate:function(e){return null===e?"":function(e,s){if(!e)return"";e=e&&13!==e.length?parseInt(e*Math.pow(10,13-e.length)):parseInt(e);var t=new Date(e),o={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};for(var n in/(y+)/.test(s)&&(s=s.replace(RegExp.$1,(t.getFullYear()+"").substr(4-RegExp.$1.length))),o)new RegExp("("+n+")").test(s)&&(s=s.replace(RegExp.$1,1===RegExp.$1.length?o[n]:("00"+o[n]).substr((""+o[n]).length)));return s}(e.toString(),"yyyy-MM-dd hh:mm")},showErrorMessage:function(e){this.$refs.errorMessage.setErrorMessage(e)},showInfoMessage:function(e){this.$refs.errorMessage.setInfoMessage(e)},webSocketInit:function(){if("undefined"==typeof WebSocket)alert("您的浏览器不支持socket");else{var e="ws://localhost:1004/websocket/"+this.selfUserInfo.id;this.socket=new WebSocket(e),this.socket.onopen=this.webSocketOpen,this.socket.onerror=this.webSocketError,this.socket.onmessage=this.webSocketGetMessage,this.socket.onclose=this.webSocketClose}},webSocketOpen:function(){this.showInfoMessage("通讯连接成功"),console.log("通讯连接成功")},webSocketError:function(){this.showErrorMessage("通讯连接异常")},webSocketGetMessage:function(e){var s=this,t=JSON.parse(e.data);t.senderUserInfo===this.info.userId||t.receiverUserInfo===this.info.userId?(this.sessionMsg.data.push(t),this.$nextTick(function(){document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight}),this.$axios.post("/chat/setReadMessage",{id:this.selfUserInfo.id,chatUserId:this.info.userId}).catch(function(e){s.showErrorMessage(e)})):this.getChatList()},webSocketSend:function(){void 0!==this.chattingRecord.chattingRecord&&null!==this.chattingRecord.chattingRecord&&""!==this.chattingRecord.chattingRecord&&(this.chattingRecord.createTime=parseInt((new Date).getTime()/1e3),this.chattingRecord.senderUserInfo=this.selfUserInfo.id,this.chattingRecord.receiverUserInfo=this.info.userId,this.socket.send(n()(this.chattingRecord)),this.chattingRecord.chattingRecord=null)},webSocketClose:function(){this.showErrorMessage("通讯连接异常关闭")}}},i={render:function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"chat"},[t("div",{staticClass:"talkList"},[e._m(0),e._v(" "),t("div",{staticClass:"talkTag"},e._l(e.talkTag.data,function(s){return t("div",{key:s.id},[t("div",{staticClass:"talkbox",class:{active:s.userId==e.info.userId},on:{click:function(t){s.unreadMessage=0,e.clickTalkBox(t,s)}}},[t("div",{staticClass:"talkcircle"},[t("img",{staticClass:"img",attrs:{src:s.userImg}})]),e._v(" "),s.unreadMessage>0?t("div",{staticClass:"unreadNumber"},[e._v(e._s(s.unreadMessage>99?"···":s.unreadMessage))]):e._e(),e._v(" "),t("label",{staticClass:"userName"},[e._v(e._s(s.userName))]),e._v(" "),t("label",{staticClass:"talkInfo"},[e._v(e._s(s.talkInfo))]),e._v(" "),t("label",{staticClass:"talkTime"},[e._v(e._s(e.formatDate(s.talkTime)))])])])}),0)]),e._v(" "),t("div",{staticClass:"session"},[void 0!==e.info.userId?t("div",{staticClass:"session-box"},[t("label",{staticClass:"userName"},[e._v(e._s(e.info.userName))]),e._v(" "),t("div",{staticClass:"session-window"},[t("div",{staticClass:"more hidden",on:{click:function(s){return e.moreChattingRecord(!0)}}},[e._v("查看更多消息")]),e._v(" "),e._l(e.sessionMsg.data,function(s){return t("div",{key:s.userId},[t("div",{staticClass:"session-msg",class:{receiver:s.senderUserInfo!==e.info.userId}},[s.senderUserInfo===e.info.userId?t("img",{staticClass:"userImg",attrs:{src:e.info.userImg}}):e._e(),e._v(" "),s.senderUserInfo!==e.info.userId?t("img",{staticClass:"userImg",attrs:{src:e.selfUserInfo.userImg}}):e._e(),e._v(" "),t("div",{staticClass:"msg-detail"},[t("div",{staticClass:"msg-title"},[s.senderUserInfo===e.info.userId?t("label",{staticClass:"user-name"},[e._v(e._s(e.info.userName))]):e._e(),e._v(" "),s.senderUserInfo!==e.info.userId?t("label",{staticClass:"user-name"},[e._v("我")]):e._e(),e._v(" "),t("label",{staticClass:"msg-time"},[e._v(e._s(e.formatDate(s.createTime)))])]),e._v(" "),t("div",{staticClass:"msg-conttent"},[e._v(e._s(s.chattingRecord))])])])])})],2),e._v(" "),void 0!==e.info.userId?t("div",{staticClass:"chatting"},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.chattingRecord.chattingRecord,expression:"chattingRecord.chattingRecord"}],staticClass:"info",attrs:{name:"talk",id:"talk",placeholder:"请输入内容"},domProps:{value:e.chattingRecord.chattingRecord},on:{input:function(s){s.target.composing||e.$set(e.chattingRecord,"chattingRecord",s.target.value)}}}),e._v(" "),t("div",{staticClass:"send"},[t("button",{staticClass:"button",attrs:{type:"submit"},on:{click:function(s){return e.webSocketSend("111")}}},[e._v("发送")])])]):e._e(),e._v(" "),void 0!==e.info.userId?t("div",{staticClass:"userInfo",attrs:{tabindex:"0",onblur:"document.querySelector('.userInfo .pop.active') !== null?document.querySelector('.userInfo .pop.active').classList.toggle('active'):'无事发生'"}},[t("span",{staticClass:"iconfont",attrs:{onclick:"document.querySelector('.userInfo .pop').classList.toggle('active')"},on:{click:e.getUserInfo}},[e._v("")]),e._v(" "),t("div",{staticClass:"pop"},[t("img",{staticClass:"userImg",attrs:{src:e.userInformation.data.userImg}}),e._v(" "),t("div",{staticClass:"userName"},[e._v(e._s(e.userInformation.data.name))]),e._v(" "),t("div",{staticClass:"userId"},[e._v("编 号: "+e._s(e.userInformation.data.id))]),e._v(" "),t("div",{staticClass:"line"}),e._v(" "),t("div",{staticClass:"userPhone"},[e._v("电话号码: "+e._s(e.userInformation.data.phoneNumber))]),e._v(" "),t("div",{staticClass:"userPhone"},[e._v("电子邮件: "+e._s(e.userInformation.data.mailbox))]),e._v(" "),t("div",{staticClass:"userAddres"},[e._v("地  区: "+e._s(e.userInformation.data.address))]),e._v(" "),t("div",{staticClass:"userDepartment"},[e._v("部  门: "+e._s(e.userInformation.data.department))])])]):e._e()]):e._e()]),e._v(" "),t("error-message",{ref:"errorMessage"})],1)},staticRenderFns:[function(){var e=this.$createElement,s=this._self._c||e;return s("div",{staticClass:"search"},[s("div",{staticClass:"search-iconfont"},[s("span",{staticClass:"iconfont",attrs:{onclick:"document.querySelector('.search').classList.toggle('active')"}},[this._v("")])]),this._v(" "),s("div",{staticClass:"search-input"},[s("input",{attrs:{type:"text",placeholder:"Search",id:"search-input"}})]),this._v(" "),s("div",{staticClass:"clear-iconfont"},[s("span",{staticClass:"iconfont",attrs:{onclick:"document.getElementById('search-input').value = ''"}},[this._v("")])])])}]};var r=t("VU/8")(a,i,!1,function(e){t("FsWm")},"data-v-a012d46a",null);s.default=r.exports},FeBl:function(e,s){var t=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=t)},FsWm:function(e,s){},mvHQ:function(e,s,t){e.exports={default:t("qkKv"),__esModule:!0}},qkKv:function(e,s,t){var o=t("FeBl"),n=o.JSON||(o.JSON={stringify:JSON.stringify});e.exports=function(e){return n.stringify.apply(n,arguments)}}});
//# sourceMappingURL=2.3fd3faea3284beee4c5e.js.map