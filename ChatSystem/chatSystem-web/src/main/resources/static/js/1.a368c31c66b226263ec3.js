webpackJsonp([1,2],{"2ddZ":function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a=s("mvHQ"),n=s.n(a);var o={components:{errorMessage:s("AVWw").a},name:"Chat",data:function(){return{chattingRecord:{createTime:null,senderUserInfo:null,receiverUserInfo:null,chattingRecord:null},socket:"",selfUserInfo:{id:1},info:{userId:null,userName:null,userImg:null,chattingRecordPage:0},talkTag:{},sessionMsg:{},userInformation:{code:null,msg:null,total:null,data:{userImg:null,name:null,id:null,phoneNumber:null,mailbox:null,address:null,department:null}}}},mounted:function(){this.info.userId=this.$route.query.userId,this.getSelfUserInfo(),this.getChatList()},methods:{getSelfUserInfo:function(){var e=this;this.$axios.get("/user/getSelfUserInfo").then(function(t){var s=t.data;0===s.code?(e.selfUserInfo=s.data,e.webSocketInit()):e.showErrorMessage(s.msg)}).catch(function(t){e.showErrorMessage(t)})},clickTalkBox:function(e,t){this.sessionMsg={},this.info.userId=t.userId,this.info.userName=t.userName,this.info.userImg=t.userImg,this.info.chattingRecordPage=0,null!==document.querySelector(".more.hidden")&&document.querySelector(".more").classList.add("hidden"),document.querySelectorAll(".talkbox.active").forEach(function(e){return e.classList.remove("active")}),e.currentTarget.className+=" active",this.moreChattingRecord(!1)},moreChattingRecord:function(e){var t=this,s=null,a=null;e&&(s=document.querySelector(".session-window").scrollHeight,a=document.querySelector(".session-window").scrollTop),this.$axios.post("/chat/getChattingRecord",{id:this.selfUserInfo.id,chatUserId:this.info.userId,page:this.info.chattingRecordPage}).then(function(s){var a=s.data;0===a.code?("{}"===n()(t.sessionMsg)?t.sessionMsg=a:t.sessionMsg.data=a.data.concat(t.sessionMsg.data),t.info.chattingRecordPage+=1,a.data.length<20&&null!==document.querySelector(".more")?document.querySelector(".more").classList.add("hidden"):20===a.data.length&&null!==document.querySelector(".more.hidden")&&document.querySelector(".more.hidden").classList.remove("hidden"),e||t.$nextTick(function(){document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight})):t.showErrorMessage(a.msg)}).catch(function(e){t.showErrorMessage(e)}).finally(function(){e&&(document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight-s+a)})},chattingScrollToBottom:function(){var e=this;this.$nextTick(function(){var t=e.$el.querySelector(".session-window");t.scrollTop=t.scrollHeight})},getChatList:function(){var e=this;this.$axios.post("/chat/getChatList",{phoneNumber:this.$cookies.get("cookie_userPhoneNumber"),userId:this.info.userId}).then(function(t){var s=t.data;if(0===s.code){if(e.talkTag=s,null!==e.info.userId)for(var a=0;a<e.talkTag.data.length;a++)if(e.talkTag.data[a].userId.toString()===e.info.userId){e.sessionMsg={},e.info.userId=e.talkTag.data[a].userId,e.info.userName=e.talkTag.data[a].userName,e.info.userImg=e.talkTag.data[a].userImg,e.info.chattingRecordPage=0,e.talkTag.data[a].unreadMessage=0,e.moreChattingRecord(!1);break}}else e.showErrorMessage(s.msg)}).catch(function(t){e.showErrorMessage(t)})},getUserInfo:function(){var e=this;this.$axios.post("/user/getUserInfo",{id:this.info.userId}).then(function(t){var s=t.data;0===s.code?e.userInformation=s:e.showErrorMessage(s.msg)}).catch(function(t){e.showErrorMessage(t)})},formatDate:function(e){return null===e?"":function(e,t){if(!e)return"";e=e&&13!==e.length?parseInt(e*Math.pow(10,13-e.length)):parseInt(e);var s=new Date(e),a={"M+":s.getMonth()+1,"d+":s.getDate(),"h+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),"q+":Math.floor((s.getMonth()+3)/3),S:s.getMilliseconds()};for(var n in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(s.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+n+")").test(t)&&(t=t.replace(RegExp.$1,1===RegExp.$1.length?a[n]:("00"+a[n]).substr((""+a[n]).length)));return t}(e.toString(),"yyyy-MM-dd hh:mm")},showErrorMessage:function(e){this.$refs.errorMessage.setErrorMessage(e)},showInfoMessage:function(e){this.$refs.errorMessage.setInfoMessage(e)},webSocketInit:function(){if("undefined"==typeof WebSocket)alert("您的浏览器不支持socket");else{var e="ws://localhost:1004/websocket/"+this.selfUserInfo.id;this.socket=new WebSocket(e),this.socket.onopen=this.webSocketOpen,this.socket.onerror=this.webSocketError,this.socket.onmessage=this.webSocketGetMessage,this.socket.onclose=this.webSocketClose}},webSocketOpen:function(){this.showInfoMessage("通讯连接成功"),console.log("通讯连接成功")},webSocketError:function(){this.showErrorMessage("通讯连接异常")},webSocketGetMessage:function(e){var t=this,s=JSON.parse(e.data);s.senderUserInfo===this.info.userId||s.receiverUserInfo===this.info.userId?(this.sessionMsg.data.push(s),this.$nextTick(function(){document.querySelector(".session-window").scrollTop=document.querySelector(".session-window").scrollHeight}),this.$axios.post("/chat/setReadMessage",{id:this.selfUserInfo.id,chatUserId:this.info.userId}).catch(function(e){t.showErrorMessage(e)})):this.getChatList()},webSocketSend:function(){void 0!==this.chattingRecord.chattingRecord&&null!==this.chattingRecord.chattingRecord&&""!==this.chattingRecord.chattingRecord&&(this.chattingRecord.createTime=parseInt((new Date).getTime()/1e3),this.chattingRecord.senderUserInfo=this.selfUserInfo.id,this.chattingRecord.receiverUserInfo=this.info.userId,this.socket.send(n()(this.chattingRecord)),this.chattingRecord.chattingRecord=null)},webSocketClose:function(){this.showErrorMessage("通讯连接异常关闭")}}},i={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"chat"},[s("div",{staticClass:"talkList"},[e._m(0),e._v(" "),s("div",{staticClass:"talkTag"},e._l(e.talkTag.data,function(t){return s("div",{key:t.id},[s("div",{staticClass:"talkbox",class:{active:t.userId==e.info.userId},on:{click:function(s){t.unreadMessage=0,e.clickTalkBox(s,t)}}},[s("div",{staticClass:"talkcircle"},[s("img",{staticClass:"img",attrs:{src:t.userImg}})]),e._v(" "),t.unreadMessage>0?s("div",{staticClass:"unreadNumber"},[e._v(e._s(t.unreadMessage>99?"···":t.unreadMessage))]):e._e(),e._v(" "),s("label",{staticClass:"userName"},[e._v(e._s(t.userName))]),e._v(" "),s("label",{staticClass:"talkInfo"},[e._v(e._s(t.talkInfo))]),e._v(" "),s("label",{staticClass:"talkTime"},[e._v(e._s(e.formatDate(t.talkTime)))])])])}),0)]),e._v(" "),s("div",{staticClass:"session"},[void 0!==e.info.userId?s("div",{staticClass:"session-box"},[s("label",{staticClass:"userName"},[e._v(e._s(e.info.userName))]),e._v(" "),s("div",{staticClass:"session-window"},[s("div",{staticClass:"more hidden",on:{click:function(t){return e.moreChattingRecord(!0)}}},[e._v("查看更多消息")]),e._v(" "),e._l(e.sessionMsg.data,function(t){return s("div",{key:t.userId},[s("div",{staticClass:"session-msg",class:{receiver:t.senderUserInfo!==e.info.userId}},[t.senderUserInfo===e.info.userId?s("img",{staticClass:"userImg",attrs:{src:e.info.userImg}}):e._e(),e._v(" "),t.senderUserInfo!==e.info.userId?s("img",{staticClass:"userImg",attrs:{src:e.selfUserInfo.userImg}}):e._e(),e._v(" "),s("div",{staticClass:"msg-detail"},[s("div",{staticClass:"msg-title"},[t.senderUserInfo===e.info.userId?s("label",{staticClass:"user-name"},[e._v(e._s(e.info.userName))]):e._e(),e._v(" "),t.senderUserInfo!==e.info.userId?s("label",{staticClass:"user-name"},[e._v("我")]):e._e(),e._v(" "),s("label",{staticClass:"msg-time"},[e._v(e._s(e.formatDate(t.createTime)))])]),e._v(" "),s("div",{staticClass:"msg-conttent"},[e._v(e._s(t.chattingRecord))])])])])})],2),e._v(" "),void 0!==e.info.userId?s("div",{staticClass:"chatting"},[s("textarea",{directives:[{name:"model",rawName:"v-model",value:e.chattingRecord.chattingRecord,expression:"chattingRecord.chattingRecord"}],staticClass:"info",attrs:{name:"talk",id:"talk",placeholder:"请输入内容"},domProps:{value:e.chattingRecord.chattingRecord},on:{input:function(t){t.target.composing||e.$set(e.chattingRecord,"chattingRecord",t.target.value)}}}),e._v(" "),s("div",{staticClass:"send"},[s("button",{staticClass:"button",attrs:{type:"submit"},on:{click:function(t){return e.webSocketSend("111")}}},[e._v("发送")])])]):e._e(),e._v(" "),void 0!==e.info.userId?s("div",{staticClass:"userInfo",attrs:{tabindex:"0",onblur:"document.querySelector('.userInfo .pop.active') !== null?document.querySelector('.userInfo .pop.active').classList.toggle('active'):'无事发生'"}},[s("span",{staticClass:"iconfont",attrs:{onclick:"document.querySelector('.userInfo .pop').classList.toggle('active')"},on:{click:e.getUserInfo}},[e._v("")]),e._v(" "),s("div",{staticClass:"pop"},[s("img",{staticClass:"userImg",attrs:{src:e.userInformation.data.userImg}}),e._v(" "),s("div",{staticClass:"userName"},[e._v(e._s(e.userInformation.data.name))]),e._v(" "),s("div",{staticClass:"userId"},[e._v("编 号: "+e._s(e.userInformation.data.id))]),e._v(" "),s("div",{staticClass:"line"}),e._v(" "),s("div",{staticClass:"userPhone"},[e._v("电话号码: "+e._s(e.userInformation.data.phoneNumber))]),e._v(" "),s("div",{staticClass:"userPhone"},[e._v("电子邮件: "+e._s(e.userInformation.data.mailbox))]),e._v(" "),s("div",{staticClass:"userAddres"},[e._v("地  区: "+e._s(e.userInformation.data.address))]),e._v(" "),s("div",{staticClass:"userDepartment"},[e._v("部  门: "+e._s(e.userInformation.data.department))])])]):e._e()]):e._e()]),e._v(" "),s("error-message",{ref:"errorMessage"})],1)},staticRenderFns:[function(){var e=this.$createElement,t=this._self._c||e;return t("div",{staticClass:"search"},[t("div",{staticClass:"search-iconfont"},[t("span",{staticClass:"iconfont",attrs:{onclick:"document.querySelector('.search').classList.toggle('active')"}},[this._v("")])]),this._v(" "),t("div",{staticClass:"search-input"},[t("input",{attrs:{type:"text",placeholder:"Search",id:"search-input"}})]),this._v(" "),t("div",{staticClass:"clear-iconfont"},[t("span",{staticClass:"iconfont",attrs:{onclick:"document.getElementById('search-input').value = ''"}},[this._v("")])])])}]};var r=s("VU/8")(o,i,!1,function(e){s("FsWm")},"data-v-a012d46a",null);t.default=r.exports},FeBl:function(e,t){var s=e.exports={version:"2.6.12"};"number"==typeof __e&&(__e=s)},FsWm:function(e,t){},RDcg:function(e,t){},dAjm:function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var a={components:{Chat:s("2ddZ").default},name:"homePage"},n={render:function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{staticClass:"homePage"},[s("router-view"),e._v(" "),s("div",{staticClass:"navigationBar"},[s("ul",[s("li",{staticClass:"navigation-list",class:{active:"/chatSystem/chat"==this.$route.path}},[s("router-link",{staticClass:"router-link",attrs:{to:"/chatSystem/chat"}},[s("span",{staticClass:"iconfont"},[e._v("")]),e._v(" "),s("span",{staticClass:"iconfont-text"},[e._v("聊天")])])],1),e._v(" "),s("li",{staticClass:"navigation-list",class:{active:"/chatSystem/contacts"==this.$route.path}},[s("router-link",{staticClass:"router-link",attrs:{to:"/chatSystem/contacts"}},[s("span",{staticClass:"iconfont"},[e._v("")]),e._v(" "),s("span",{staticClass:"iconfont-text"},[e._v("通讯录")])])],1),e._v(" "),s("li",{staticClass:"navigation-list",class:{active:"/chatSystem/userInfo"==this.$route.path}},[s("router-link",{staticClass:"router-link",attrs:{to:"/chatSystem/userInfo"}},[s("span",{staticClass:"iconfont"},[e._v("")]),e._v(" "),s("span",{staticClass:"iconfont-text"},[e._v("个人信息")])])],1)])])],1)},staticRenderFns:[]};var o=s("VU/8")(a,n,!1,function(e){s("RDcg")},"data-v-45bbaad0",null);t.default=o.exports},mvHQ:function(e,t,s){e.exports={default:s("qkKv"),__esModule:!0}},qkKv:function(e,t,s){var a=s("FeBl"),n=a.JSON||(a.JSON={stringify:JSON.stringify});e.exports=function(e){return n.stringify.apply(n,arguments)}}});
//# sourceMappingURL=1.a368c31c66b226263ec3.js.map